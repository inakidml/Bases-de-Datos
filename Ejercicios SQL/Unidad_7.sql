/*EJERCICO 1*/

CREATE TABLE NOTAS_ALUMNOS
(
  NOMBRE_ALUMNO    VARCHAR2(25) PRIMARY KEY,
  NOTA1 NUMBER(2),
  NOTA2 NUMBER(2),
  NOTA3 NUMBER(2));
  
INSERT INTO NOTAS_ALUMNOS VALUES('Alcalde García, Elena', 5,5,5);
INSERT INTO NOTAS_ALUMNOS VALUES('Benito Martín, Luis', 7,6,8);
INSERT INTO NOTAS_ALUMNOS VALUES('Casas Martinez, Manuel', 7,5,5);
INSERT INTO NOTAS_ALUMNOS VALUES('Corregidor Sanchez,Ana',6,9,8);
SELECT * FROM NOTAS_ALUMNOS;
select NOMBRE_ALUMNO "Nombre del alumno",((NOTA1 + NOTA2 + NOTA3)/3) AS "Nota media" FROM NOTAS_ALUMNOS;   

/*eJERCICO 2*/
DROP TABLE DEPART CASCADE CONSTRAINTS; 
CREATE TABLE DEPART (
 	DEPT_NO  NUMBER(2) CONSTRAINT DEP_PK PRIMARY KEY,
	DNOMBRE  VARCHAR2(14), 
 	LOC      VARCHAR2(14));
  
INSERT INTO DEPART VALUES (10,'CONTABILIDAD','SEVILLA');
INSERT INTO DEPART VALUES (20,'INVESTIGACION','MADRID');
INSERT INTO DEPART VALUES (30,'VENTAS','BARCELONA');
INSERT INTO DEPART VALUES (40,'PRODUCCION','BILBAO');

COMMIT;

DROP TABLE EMPLE CASCADE CONSTRAINTS; 

CREATE TABLE EMPLE (
 	EMP_NO    NUMBER(4) CONSTRAINT EMP_PK PRIMARY KEY,
 	APELLIDO  VARCHAR2(10),
 	OFICIO    VARCHAR2(10),
 	DIR       NUMBER(4) CONSTRAINT EMP_DIR_FK  REFERENCES EMPLE ON DELETE SET NULL,
 	FECHA_ALT DATE,
 	SALARIO   NUMBER(10),
 	COMISION  NUMBER(10),
 	DEPT_NO   NUMBER(2) NOT NULL CONSTRAINT EMP_DEP_FK 	REFERENCES DEPART ON DELETE CASCADE);
  
  
INSERT INTO EMPLE VALUES (7839,'REY','PRESIDENTE',NULL,'17/12/1981',650000,NULL,10);
INSERT INTO EMPLE VALUES (7566,'JIMENEZ','DIRECTOR',7839,'02/04/1981',386750,NULL,20);
INSERT INTO EMPLE VALUES (7698,'NEGRO','DIRECTOR',7839,'01/05/1981',370500,NULL,30);
INSERT INTO EMPLE VALUES (7782,'CEREZO','DIRECTOR',7839,'09/06/1981',318500,NULL,10);
INSERT INTO EMPLE VALUES (7788,'GIL','ANALISTA',7566,'09/11/1981',390000,NULL,20);
INSERT INTO EMPLE VALUES (7902,'FERNANDEZ','ANALISTA',7566,'03/12/1981',390000,NULL,20);
INSERT INTO EMPLE VALUES (7499,'ARROYO','VENDEDOR',7698,'20/02/1980',208000,39000,30);
INSERT INTO EMPLE VALUES (7521,'SALA','VENDEDOR',7698,'22/02/1981',162500,65000,30);
INSERT INTO EMPLE VALUES (7654,'MARTIN','VENDEDOR',7698,'29/09/1981',162500,182000,30);
INSERT INTO EMPLE VALUES (7844,'TOVAR','VENDEDOR',7698,'08/09/1981',195000,0,30);
INSERT INTO EMPLE VALUES (7900,'JIMENO','EMPLEADO',7698,'03/12/1981',123500,NULL,30);
INSERT INTO EMPLE VALUES (7369,'SANCHEZ','EMPLEADO',7902,'17/12/1980',104000,NULL,20);
INSERT INTO EMPLE VALUES (7876,'ALONSO','EMPLEADO',7788,'23/09/1981',143000,NULL,20);
INSERT INTO EMPLE VALUES (7934,'MUÑOZ','EMPLEADO',7782,'23/01/1982',169000,NULL,10);

SELECT APELLIDO, SALARIO, DEPT_NO FROM EMPLE WHERE SALARIO>200000 AND DEPT_NO IN(10,20);

/*EJERCICO 3*/

SELECT * FROM NOTAS_ALUMNOS;
SELECT NOMBRE_ALUMNO FROM NOTAS_ALUMNOS WHERE NOTA1 = 7 AND ((NOTA1 + NOTA2 + NOTA3)/3)>6;

/*EJERCICO 4*/

SELECT * FROM EMPLE;
SELECT APELLIDO FROM EMPLE WHERE (UPPER(APELLIDO)) LIKE 'J%';

/*EJERCICIO 5*/

SELECT APELLIDO FROM EMPLE WHERE (UPPER(APELLIDO)) LIKE '_R%';

/*EJERCICO 6*/

SELECT APELLIDO FROM EMPLE WHERE (UPPER(APELLIDO)) LIKE 'A%O%';

/*EJERCICIO 7*/

SELECT APELLIDO, SALARIO FROM EMPLE WHERE SALARIO BETWEEN 150000 AND 200000;

/*EJERCICIO 8*/

SELECT APELLIDO, SALARIO FROM EMPLE WHERE SALARIO NOT BETWEEN 150000 AND 200000;

/*EJERCICIO 9*/

SELECT APELLIDO FROM EMPLE WHERE OFICIO IN('VENDEDOR','ANALISTA','EMPLEADO');

/*EJERCICIO 10*/

SELECT APELLIDO FROM EMPLE WHERE OFICIO NOT IN('VENDEDOR','ANALISTA','EMPLEADO');

/*EJERCICIO 11*/

SELECT APELLIDO FROM EMPLE WHERE COMISION IS NULL;

/*EJERCICIO 12*/

SELECT DISTINCT OFICIO FROM EMPLE;

/*EJERCICIO 13*/

SELECT EMP_NO, APELLIDO, OFICIO, DEPT_NO 
FROM EMPLE 
WHERE DEPT_NO = 20 ORDER BY APELLIDO, SALARIO DESC;

/*EJERCICIO 14*/

SELECT EMP_NO, APELLIDO, OFICIO, DEPT_NO 
FROM EMPLE 
WHERE OFICIO = 'ANALISTA' ORDER BY EMP_NO;

/*EJERCICO 15*/

SELECT EMP_NO, APELLIDO, OFICIO, DEPT_NO 
FROM EMPLE 
WHERE (DEPT_NO = 20 )AND (OFICIO = 'ANALISTA') ORDER BY APELLIDO DESC, EMP_NO DESC;

/*EJERCICIO 16*/

SELECT APELLIDO, OFICIO, FECHA_ALT 
FROM EMPLE 
WHERE FECHA_ALT BETWEEN '01/05/1981' AND '30/09/1981' ORDER BY FECHA_ALT;

/*17*/

select * from emple;
select EMP_NO, APELLIDO, LENGTH(APELLIDO), INSTR(APELLIDO, 'A') AS "POSICION A" 
FROM EMPLE 
WHERE UPPER(APELLIDO) LIKE '%Z';

/*18*/
SELECT MOD(SALARIO, 550)AS RESTO, APELLIDO, SALARIO  
FROM EMPLE 
WHERE OFICIO = 'VENDEDOR';

/*19*/
SELECT APELLIDO, (SYSDATE-FECHA_ALT)/7 AS "SEMANAS"
FROM EMPLE WHERE DEPT_NO = 10;

/*20*/
SELECT FECHA_ALT, EMP_NO, ROUND(FECHA_ALT ,'MOONTH'), TRUNC(FECHA_ALT ,'MONTH') FROM EMPLE WHERE EXTRACT(YEAR FROM FECHA_ALT)= 1981;

/*21*/

SELECT * FROM EMPLE;
SELECT * FROM DEPART;
SELECT APELLIDO, OFICIO, EMP_NO, DNOMBRE, LOC 
FROM DEPART D, EMPLE E 
WHERE D.DEPT_NO=E.DEPT_NO;

SELECT APELLIDO, OFICIO, EMP_NO, DNOMBRE, LOC 
FROM EMPLE NATURAL JOIN DEPART;

SELECT APELLIDO, OFICIO, EMP_NO, DNOMBRE, LOC 
FROM EMPLE JOIN DEPART USING(DEPT_NO);

/*22*/
SELECT * 
FROM EMPLE JOIN DEPART USING(DEPT_NO) 
WHERE DEPART.LOC = 'MADRID' OR DEPART.LOC LIKE 'BARCELONA';

/*23*/
SELECT E.EMP_NO, E.APELLIDO, J.APELLIDO "SU JEFE ES" 
FROM EMPLE E, EMPLE J
WHERE E.DIR = J.EMP_NO;

SELECT E.EMP_NO, E.APELLIDO, J.APELLIDO "SU JEFE ES" 
FROM EMPLE E JOIN EMPLE J ON J.EMP_NO=E.DIR;

/*24*/
SELECT E.APELLIDO, E.OFICIO, D.LOC FROM EMPLE E, DEPART D WHERE OFICIO='ANALISTA' AND E.DEPT_NO=D.DEPT_NO;
SELECT APELLIDO, OFICIO, LOC FROM EMPLE NATURAL JOIN DEPART WHERE OFICIO ='ANALISTA';
/*25*/
SELECT E.APELLIDO,E.OFICIO, J.APELLIDO JEFE FROM EMPLE E, EMPLE J WHERE E.DIR = J.EMP_NO(+); 
/*26*/
SELECT D.DEPT_NO, D.DNOMBRE, E.APELLIDO FROM EMPLE E, DEPART D WHERE E.DEPT_NO(+)=D.DEPT_NO;
/*27*/
SELECT *FROM EMPLE;

SELECT DISTINCT E.OFICIO, D.LOC /*PARA QUE NO SAQUE LOS REPETIDOS*/
FROM EMPLE E, DEPART D 
WHERE E.DEPT_NO =D.DEPT_NO
AND E.DEPT_NO='30';/* El CAMPO DE UNA Y DE OTRA SEA IGUAL Y ADEMAS 30*/

SELECT DISTINCT E.OFICIO,D.LOC FROM EMPLE E NATURAL JOIN DEPART D WHERE DEPT_NO=30;

/*28*/
SELECT E.APELLIDO, E.FECHA_ALT           /*LAS CUATRO IGUALES*/
FROM EMPLE E, EMPLE E2 
WHERE E.FECHA_ALT > E2.FECHA_ALT AND E2.APELLIDO = 'JIMENEZ';

SELECT E.APELLIDO, E.FECHA_ALT 
FROM EMPLE E JOIN EMPLE E2 ON E2.APELLIDO='JIMENEZ'
WHERE E.FECHA_ALT > E2.FECHA_ALT;

SELECT E.APELLIDO, E.FECHA_ALT 
FROM EMPLE E CROSS JOIN EMPLE E2 
WHERE E.FECHA_ALT > E2.FECHA_ALT AND E2.APELLIDO = 'JIMENEZ';

SELECT APELLIDO, FECHA_ALT 
FROM EMPLE 
WHERE FECHA_ALT > (SELECT FECHA_ALT FROM EMPLE WHERE APELLIDO = 'JIMENEZ');

/*29*/
SELECT E.APELLIDO AS EMPLEADO, E.FECHA_ALT, D.APELLIDO DIRECTOR, D.FECHA_ALT 
FROM EMPLE E, EMPLE D 
WHERE D.EMP_NO = E.DIR AND E.FECHA_ALT < D.FECHA_ALT;

SELECT E.APELLIDO AS EMPLEADO, E.FECHA_ALT, D.APELLIDO DIRECTOR, D.FECHA_ALT 
FROM EMPLE E JOIN EMPLE D ON D.EMP_NO = E.DIR 
WHERE E.FECHA_ALT < D.FECHA_ALT ;
/*30*/
SELECT AVG(SALARIO), MAX(SALARIO), MIN(SALARIO), SUM(SALARIO) FROM EMPLE WHERE OFICIO = 'VENDEDOR';

/*31*/
SELECT MAX(FECHA_ALT), MIN(FECHA_ALT) FROM EMPLE;
SELECT APELLIDO, FECHA_ALT 
FROM EMPLE
WHERE FECHA_ALT = (SELECT MAX(FECHA_ALT) FROM EMPLE)OR FECHA_ALT = (SELECT MIN(FECHA_ALT) FROM EMPLE);
/*32*/
SELECT COUNT(EMP_NO) FROM EMPLE 
WHERE DEPT_NO=40;

/*33*/
SELECT COUNT(EMP_NO) AS "NUMERO EMPLEADOS" FROM EMPLE 
WHERE COMISION IS NOT NULL AND DEPT_NO=30;
/*34*/
SELECT COUNT(*) AS "NUMERO DE EMPLEADOS", DEPT_NO
FROM EMPLE GROUP BY DEPT_NO;
/*35*/
select * from depart;
SELECT COUNT(emp_no) AS "NUMERO DE EMPLEADOS", e.DEPT_NO, d.dnombre
FROM EMPLE e, depart d 
where e.dept_no=d.dept_no 
GROUP BY e.DEPT_NO, d.dnombre 
HAVING COUNT(*) > 4 
ORDER BY "NUMERO DE EMPLEADOS" DESC;
/*36*/
SELECT COUNT(EMP_NO) AS "NUMERO DE EMPLEADOS", E.OFICIO, D.DNOMBRE AS "DEPARTAMENTO" 
FROM EMPLE E, DEPART D 
WHERE e.DEPT_NO=d.DEPT_NO
GROUP BY E.OFICIO,D.DNOMBRE
ORDER BY D.DNOMBRE;

SELECT DEPT_NO, OFICIO, COUNT(*) "NUMERO DE EMPLEADOS" 
FROM EMPLE 
GROUP BY OFICIO, DEPT_NO;
/*37*/
SELECT MAX(COUNT(*)) AS "NUMERO EMPLEADOS" 
FROM EMPLE 
GROUP BY DEPT_NO ;
/*38*/
SELECT D.DEPT_NO, D.DNOMBRE, COUNT(EMP_NO) 
FROM EMPLE E, DEPART D 
WHERE e.DEPT_NO(+)=d.DEPT_NO
GROUP BY D.DEPT_NO,D.DNOMBRE
ORDER BY DEPT_NO;
/*39*/
SELECT DEPT_NO, ROUND(AVG(SALARIO)) FROM EMPLE
GROUP BY DEPT_NO
HAVING (MAX(SALARIO)>250000);
/*40*/
SELECT MAX(AVG(SALARIO)) FROM EMPLE GROUP BY DEPT_NO;
/*41*/
SELECT OFICIO, COUNT(EMP_NO) FROM EMPLE GROUP BY OFICIO;
/*42*/
SELECT * FROM EMPLE;
SELECT DIR, MIN(SALARIO) 
FROM EMPLE 
WHERE DIR IS NOT NULL
GROUP BY DIR 
HAVING MIN(SALARIO)<200000 
ORDER BY MIN(SALARIO) DESC; 
/*43*/
SELECT DNOMBRE, LOC, 
COUNT(EMP_NO) AS "NUMERO EMPLE", 
ROUND(AVG(SALARIO),2) AS "SALARIO MEDIO" 
FROM EMPLE, DEPART 
WHERE EMPLE.DEPT_NO=DEPART.DEPT_NO 
GROUP BY EMPLE.DEPT_NO, DNOMBRE, LOC;
/*44*/
SELECT COUNT(EMP_NO)
FROM EMPLE, DEPART 
WHERE DNOMBRE='VENTAS' 
AND OFICIO='VENDEDOR' 
AND EMPLE.DEPT_NO=DEPART.DEPT_NO;
/*45*/
SELECT * FROM EMPLE;
SELECT * FROM DEPART;
select SUM(EMPLE.SALARIO), EMPLE.OFICIO 
FROM EMPLE, DEPART 
WHERE EMPLE.DEPT_NO=DEPART.DEPT_NO AND DEPART.DNOMBRE='VENTAS'
GROUP BY EMPLE.OFICIO/*,DEPART.DNOMBRE 
HAVING DEPART.DNOMBRE='VENTAS'*/;
/*46*/
SELECT COUNT(EMP_NO), DEPT_NO 
FROM EMPLE 
WHERE OFICIO='EMPLEADO' 
GROUP BY DEPT_NO;
/*47*/ 
SELECT DEPT_NO, OFICIO, COUNT(EMP_NO) 
FROM EMPLE 
GROUP BY DEPT_NO, OFICIO 
HAVING COUNT(*)>2;
/*48*/
SELECT E.APELLIDO 
FROM EMPLE E, EMPLE D 
WHERE E.OFICIO=D.OFICIO AND D.APELLIDO= 'GIL' AND E.APELLIDO<>'GIL';

SELECT APELLIDO 
FROM EMPLE 
WHERE OFICIO = (SELECT OFICIO FROM EMPLE WHERE APELLIDO='GIL') AND APELLIDO <> 'GIL';
/*49*/
/*DEVUELVE MAS DE UNA TUPLA EN VEZ DE = PONEMOS IN*/
SELECT EMP_NO, APELLIDO
FROM   EMPLE
WHERE  SALARIO IN ( SELECT MIN(SALARIO)
			   FROM EMPLE
			   GROUP BY DEPT_NO);
         
/*50*/
SELECT APELLIDO, OFICIO
FROM   EMPLE
WHERE  OFICIO = ( SELECT OFICIO
                   FROM EMPLE
                  WHERE APELLIDO = 'PEREZ');
/*51*/
SELECT APELLIDO, DEPT_NO, SALARIO 
FROM EMPLE 
WHERE (DEPT_NO, SALARIO) IN 
  (SELECT DEPT_NO, SALARIO FROM EMPLE WHERE COMISION > 0);
/*52*/
SELECT APELLIDO, D.DNOMBRE, SALARIO,COMISION FROM EMPLE E, DEPART D 
WHERE E.DEPT_NO=D.DEPT_NO AND  (SALARIO, COMISION) IN 
                        (SELECT E.SALARIO, E.COMISION 
                          FROM EMPLE E, DEPART D 
                          WHERE E.DEPT_NO=D.DEPT_NO AND LOC='BARCELONA');
                          
/*53*/
SELECT * FROM EMPLE;
SELECT E.EMP_NO, E.APELLIDO, E.DEPT_NO, D.LOC 
FROM EMPLE E, DEPART D 
WHERE E.DEPT_NO=D.DEPT_NO AND D.LOC IN 
    (SELECT LOC FROM DEPART WHERE LOC LIKE '%A');

/*54*/
SELECT EMP_NO, APELLIDO, SALARIO, OFICIO 
FROM EMPLE 
WHERE SALARIO > ALL 
    (SELECT SALARIO FROM EMPLE WHERE OFICIO='DIRECTOR')
ORDER BY SALARIO DESC;

/*55*/
SELECT E.APELLIDO, E.SALARIO, E.DEPT_NO, AVG(A.SALARIO) 
FROM EMPLE E, EMPLE A
WHERE A.DEPT_NO=A.DEPT_NO AND 
E.SALARIO > 
    (SELECT AVG(SALARIO)FROM EMPLE A where A.DEPT_NO=E.DEPT_NO)
    GROUP BY E.APELLIDO, E.SALARIO, E.DEPT_NO
    ORDER BY AVG(A.SALARIO);/*NO ME FUNCIONA BIEN*/
    
SELECT APELLIDO, SALARIO,P.DEPT_NO, S.SALMEDIO   /*Otra forma mas clara*/
FROM EMPLE P, (SELECT DEPT_NO, AVG(SALARIO) SALMEDIO FROM EMPLE GROUP BY DEPT_NO) S
WHERE P.DEPT_NO=S.DEPT_NO
AND P.SALARIO>S.SALMEDIO
ORDER BY S.SALMEDIO;
/*56*/

/*57*/
SELECT APELLIDO
FROM EMPLE E 
WHERE NOT EXISTS
  (SELECT * FROM EMPLE S WHERE E.EMP_NO=S.DIR); 

SELECT APELLIDO   /*OTRA FORMA*/
FROM EMPLE 
WHERE EMP_NO NOT IN 
  (SELECT DISTINCT DIR FROM EMPLE WHERE DIR IS NOT NULL);


/*58*/
SELECT LEVEL, APELLIDO 
FROM EMPLE 
START WITH APELLIDO='JIMENO' 
CONNECT BY PRIOR DIR=EMP_NO;
SELECT LEVEL, APELLIDO 
FROM EMPLE 
START WITH APELLIDO='REY' 
CONNECT BY DIR=PRIOR EMP_NO;/*aL REVES*/
/*59*/
SELECT DEPT_NO 
FROM DEPART 
MINUS 
SELECT DEPT_NO 
FROM EMPLE 
WHERE OFICIO='ANALISTA';